

<div class="p-10 bg-no-repeat bg-cover" style="background-image: url('assets/fondo-dashboard.png'); background-size: 60%; background-position: top center;" >
  <!-- Success and error messages -->
  <br/>
  @if (success) {
    <div class="p-4 mb-4 text-sm text-green-800 rounded-lg bg-green-50 dark:bg-gray-800 dark:text-green-400" role="alert">
      {{ success }}
    </div>
  }

  @if (error) {
    <div class="p-4 mb-4 text-sm text-red-800 rounded-lg bg-red-50 dark:bg-gray-800 dark:text-red-400" role="alert">
      {{ error }}
    </div>
  }

  <!-- Header with create button -->
  <div class="flex justify-between items-center mb-6 mt-10">
    <h1 class="text-2xl font-bold text-gray-900">Gestión de Usuarios</h1>
    <button
      (click)="openDrawer('drawer-right-example2')"
      class="text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 focus:outline-none">
      Crear usuario
    </button>
  </div>

  <!-- Users table -->
  <div class="relative overflow-x-auto shadow-md sm:rounded-lg">
    <table class="w-full text-sm text-left rtl:text-right text-gray-500 dark:text-gray-400">
      <thead class="text-xs text-gray-700 uppercase bg-gray-50 dark:bg-gray-700 dark:text-gray-400">
        <tr>
          <th scope="col" class="px-6 py-3">ID</th>
          <th scope="col" class="px-6 py-3">Nombre</th>
          <th scope="col" class="px-6 py-3">Email</th>
          <th scope="col" class="px-6 py-3">Username</th>
          <th scope="col" class="px-6 py-3">Acciones</th>
        </tr>
      </thead>
      <tbody>
        @if (isLoading) {
          <tr>
            <td colspan="5" class="px-6 py-4 text-center">
              <div class="flex justify-center items-center">
                <svg class="animate-spin h-5 w-5 mr-3 text-blue-500" viewBox="0 0 24 24">
                  <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                  <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Cargando usuarios...
              </div>
            </td>
          </tr>
        } @else {
          @for (usuario of usuarios; track usuario.id) {
            <tr class="bg-white border-b dark:bg-gray-800 dark:border-gray-700 hover:bg-gray-50 dark:hover:bg-gray-600">
              <td class="px-6 py-4">{{ usuario.id }}</td>
              <td class="px-6 py-4">{{ usuario.nombre }}</td>
              <td class="px-6 py-4">{{ usuario.email }}</td>
              <td class="px-6 py-4">{{ usuario.username }}</td>
              <td class="px-6 py-4 flex space-x-2">
                <button (click)="viewUserDetails(usuario)" class="font-medium text-blue-600 dark:text-blue-500 hover:underline" title="Ver">
                  <i class="fa fa-eye"></i>
                </button>
                <button (click)="editUser(usuario)" class="font-medium text-green-600 dark:text-green-500 hover:underline" title="Editar">
                  <i class="fa fa-pen"></i>
                </button>
                <button (click)="deleteUser(usuario.id)" class="font-medium text-red-600 dark:text-red-500 hover:underline" title="Eliminar">
                  <i class="fa fa-trash"></i>
                </button>
              </td>
            </tr>
          } @empty {
            <tr>
              <td colspan="5" class="px-6 py-4 text-center text-gray-500">
                No hay usuarios para mostrar.
              </td>
            </tr>
          }
        }
      </tbody>
    </table>
  </div>

  <!-- Create/Edit User Drawer -->
  <div id="drawer-right-example2"
    class="fixed shadow-lg border border-gray-300 top-0 right-0 z-50 h-screen p-4 overflow-y-auto transition-transform translate-x-full bg-white w-96 dark:bg-gray-800"
    tabindex="-1"
    aria-labelledby="drawer-right-label2">

    <h5 id="drawer-right-label2" class="inline-flex items-center mb-6 text-xl font-semibold text-gray-900 dark:text-white">
      {{ isEditing ? 'Editar Usuario' : 'Crear Usuario' }}
    </h5>

    <button
      (click)="closeDrawer('drawer-right-example2')"
      type="button"
      class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 absolute top-2.5 end-2.5 inline-flex items-center justify-center">
      <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
      </svg>
      <span class="sr-only">Close menu</span>
    </button>

    <!-- User Form -->
    <form [formGroup]="userForm" (ngSubmit)="onSubmit()" class="space-y-4">
      <!-- Name -->
      <div>
        <label for="name" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nombre completo</label>
        <input
          type="text"
          id="name"
          formControlName="name"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          placeholder="Nombre completo">
        @if (userForm.get('name')?.invalid && userForm.get('name')?.touched) {
          <p class="mt-1 text-sm text-red-600">
            @if (userForm.get('name')?.errors?.['required']) {
              El nombre es obligatorio
            } @else if (userForm.get('name')?.errors?.['minlength']) {
              El nombre debe tener al menos 3 caracteres
            }
          </p>
        }
      </div>

      <!-- Email -->
      <div>
        <label for="email" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Email</label>
        <input
          type="email"
          id="email"
          formControlName="email"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          placeholder="correo@ejemplo.com">
        @if (userForm.get('email')?.invalid && userForm.get('email')?.touched) {
          <p class="mt-1 text-sm text-red-600">
            @if (userForm.get('email')?.errors?.['required']) {
              El email es obligatorio
            } @else if (userForm.get('email')?.errors?.['email']) {
              El formato del email es inválido
            }
          </p>
        }
      </div>

      <!-- Username -->
      <div>
        <label for="usernick" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">Nombre de usuario</label>
        <input
          type="text"
          id="usernick"
          formControlName="usernick"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          placeholder="usuario123">
        @if (userForm.get('usernick')?.invalid && userForm.get('usernick')?.touched) {
          <p class="mt-1 text-sm text-red-600">
            @if (userForm.get('usernick')?.errors?.['required']) {
              El nombre de usuario es obligatorio
            } @else if (userForm.get('usernick')?.errors?.['minlength']) {
              El nombre de usuario debe tener al menos 3 caracteres
            }
          </p>
        }
      </div>

      <!-- Password -->
      <div>
        <label for="password" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">
          Contraseña {{ isEditing ? '(dejar en blanco para no cambiar)' : '' }}
        </label>
        <input
          type="password"
          id="password"
          formControlName="password"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          placeholder="••••••••">
        @if (userForm.get('password')?.invalid && userForm.get('password')?.touched) {
          <p class="mt-1 text-sm text-red-600">
            @if (userForm.get('password')?.errors?.['required']) {
              La contraseña es obligatoria
            } @else if (userForm.get('password')?.errors?.['minlength']) {
              La contraseña debe tener al menos 6 caracteres
            }
          </p>
        }
      </div>

      <!-- Photo URL -->
      <div>
        <label for="photo_path" class="block mb-2 text-sm font-medium text-gray-900 dark:text-white">URL de foto (opcional)</label>
        <input
          type="text"
          id="photo_path"
          formControlName="photo_path"
          class="bg-gray-50 border border-gray-300 text-gray-900 text-sm rounded-lg focus:ring-blue-500 focus:border-blue-500 block w-full p-2.5"
          placeholder="https://ejemplo.com/foto.jpg">
      </div>

      <!-- Submit y Limpiar Buttons -->
      <div class="flex gap-2">
        <button
          type="submit"
          [disabled]="userForm.invalid || isLoading"
          class="w-full text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center disabled:opacity-50 disabled:cursor-not-allowed">
          {{ isEditing ? 'Actualizar' : 'Crear' }} Usuario
        </button>
        <button
          type="button"
          (click)="limpiarFormulario()"
          class="w-full text-white bg-green-600 hover:bg-green-700 focus:ring-4 focus:ring-green-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
          Limpiar
        </button>
      </div>
    </form>
  </div>

  <!-- User Details Drawer -->
  <div id="drawer-user-details"
    class="fixed shadow-lg border border-gray-300 top-0 right-0 z-50 h-screen p-4 overflow-y-auto transition-transform translate-x-full bg-white w-96 dark:bg-gray-800"
    tabindex="-1"
    aria-labelledby="drawer-user-details-label">

    <h5 id="drawer-user-details-label" class="inline-flex items-center mb-6 text-xl font-semibold text-gray-900 dark:text-white">
      Detalles del Usuario
    </h5>

    <button
      (click)="closeDrawer('drawer-user-details')"
      type="button"
      class="text-gray-400 bg-transparent hover:bg-gray-200 hover:text-gray-900 rounded-lg text-sm w-8 h-8 absolute top-2.5 end-2.5 inline-flex items-center justify-center">
      <svg class="w-3 h-3" aria-hidden="true" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 14 14">
        <path stroke="currentColor" stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="m1 1 6 6m0 0 6 6M7 7l6-6M7 7l-6 6"/>
      </svg>
      <span class="sr-only">Close menu</span>
    </button>

    @if (selectedUser) {
      <div class="space-y-4">
        <!-- User Photo -->
        <div class="flex justify-center mb-4">
          <img
            [src]="selectedUser.photopath || 'assets/logo.png'"
            alt="User photo"
            class="w-32 h-32 rounded-full object-cover border-4 border-blue-500">
        </div>

        <!-- User Details -->
        <div class="space-y-3">
          <div>
            <h6 class="text-sm font-medium text-gray-500 dark:text-gray-400">ID</h6>
            <p class="text-base text-gray-900 dark:text-white">{{ selectedUser.id }}</p>
          </div>

          <div>
            <h6 class="text-sm font-medium text-gray-500 dark:text-gray-400">Nombre</h6>
            <p class="text-base text-gray-900 dark:text-white">{{ selectedUser.nombre }}</p>
          </div>

          <div>
            <h6 class="text-sm font-medium text-gray-500 dark:text-gray-400">Email</h6>
            <p class="text-base text-gray-900 dark:text-white">{{ selectedUser.email }}</p>
          </div>

          <div>
            <h6 class="text-sm font-medium text-gray-500 dark:text-gray-400">Nombre de usuario</h6>
            <p class="text-base text-gray-900 dark:text-white">{{ selectedUser.username }}</p>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="flex space-x-2 pt-4">
          <button
            (click)="editUser(selectedUser)"
            class="flex-1 text-white bg-blue-700 hover:bg-blue-800 focus:ring-4 focus:ring-blue-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
            Editar
          </button>

          <button
            (click)="deleteUser(selectedUser.id); closeDrawer('drawer-user-details')"
            class="flex-1 text-white bg-red-700 hover:bg-red-800 focus:ring-4 focus:ring-red-300 font-medium rounded-lg text-sm px-5 py-2.5 text-center">
            Eliminar
          </button>
        </div>
      </div>
    }
  </div>
</div>
